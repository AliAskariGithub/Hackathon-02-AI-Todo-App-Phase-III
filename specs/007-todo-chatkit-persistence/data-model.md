# Data Model: ChatKit UI & Persistence

**Feature**: 007-todo-chatkit-persistence
**Date**: 2026-02-06

## Entities

### Conversation
Represents a single chat conversation thread with metadata and user association.

**Fields**:
- `id` (UUID, primary key): Unique identifier for the conversation
- `title` (string): Descriptive title for the conversation (derived from first message or user input)
- `user_id` (UUID, foreign key): Reference to the user who owns the conversation
- `created_at` (datetime): Timestamp when the conversation was created
- `updated_at` (datetime): Timestamp when the conversation was last updated

**Validation Rules**:
- `title` must be between 1-200 characters
- `user_id` must exist in the users table
- All fields are required except `updated_at` (auto-generated)

**Relationships**:
- **One-to-Many**: One Conversation to Many Messages
- **Many-to-One**: One User to Many Conversations

### Message
Represents an individual message within a conversation thread.

**Fields**:
- `id` (UUID, primary key): Unique identifier for the message
- `conversation_id` (UUID, foreign key): Reference to the conversation containing this message
- `role` (string): Message role ('user' or 'assistant')
- `content` (string): The actual message content
- `tool_calls` (List[Dict], optional): Information about any MCP tools called in this message
- `created_at` (datetime): Timestamp when the message was created

**Validation Rules**:
- `content` must be at least 1 character long
- `role` must be one of ['user', 'assistant']
- `conversation_id` must exist in the conversations table
- `tool_calls` must be a valid JSON array of tool call objects

**Relationships**:
- **Many-to-One**: Many Messages to One Conversation
- **Message belongs to**: Single Conversation (via conversation_id FK)

### ChatSession (Runtime Entity)
Represents an active chat session state in the UI layer.

**Fields**:
- `session_id` (string): Temporary session identifier
- `conversation_id` (UUID): Current conversation in the session
- `user_id` (UUID): User associated with the session
- `created_at` (datetime): Session creation time
- `expires_at` (datetime): Session expiration time

**Validation Rules**:
- Session must be tied to valid user and conversation
- Session should expire after a period of inactivity
- Session user must match conversation owner

## Relationships

### User ↔ Conversation
- **Cardinality**: One-to-Many (One user can have many conversations)
- **Constraint**: Users can only access their own conversations
- **Validation**: JWT token must match conversation's user_id

### Conversation ↔ Message
- **Cardinality**: One-to-Many (One conversation can have many messages)
- **Constraint**: All messages in a conversation must belong to the same user
- **Cascade**: Messages are deleted when their conversation is deleted
- **Ordering**: Messages ordered by created_at timestamp

### Message ↔ Tool Calls (Embedded)
- **Type**: One-to-Many (One message can have many tool calls)
- **Structure**: Tool calls stored as JSON array in message's tool_calls field
- **Schema**: Each tool call has name, arguments, and result fields

## State Transitions

### Conversation States
1. **Active**: New conversation created and ready for messages
2. **Archived**: Conversation moved to archive after period of inactivity
3. **Deleted**: Conversation and all messages permanently removed

### Message States
1. **Pending**: Message received, awaiting processing
2. **Processing**: Message being handled by AI agent or MCP tools
3. **Complete**: Message processing finished, response generated
4. **Error**: Message processing failed

### Tool Call States
1. **Initiated**: Tool call started from assistant response
2. **Executing**: MCP tool being executed
3. **Completed**: Tool execution finished successfully
4. **Failed**: Tool execution resulted in error

## Constraints

### Security Constraints
- No cross-user access allowed to conversations or messages
- All operations must be validated against authenticated user context
- Tool calls must execute within user's authentication scope

### Data Integrity Constraints
- Referential integrity enforced between user ↔ conversation and conversation ↔ message
- All timestamps automatically generated by database
- Text fields have proper length limits to prevent abuse

### Business Logic Constraints
- Conversations belong to exactly one user
- Messages belong to exactly one conversation
- Tool calls are tied to user's authorization context
- Message ordering maintained by timestamp

## Indexes & Performance

### Required Indexes
- `idx_conversation_user_id`: Index on conversations.user_id for fast user filtering
- `idx_message_conversation_created`: Composite index on messages(conversation_id, created_at) for chronological ordering
- `idx_conversation_updated`: Index on conversations.updated_at for sorting by recency

### Performance Optimizations
- Pagination by default (limit 20 messages per request)
- Conversation titles generated efficiently from first few messages
- Tool call data indexed separately for quick status checks