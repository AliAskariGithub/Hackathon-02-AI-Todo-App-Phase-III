# Quickstart Guide: Auth System & API Security

## Prerequisites

- Node.js 18+ for Next.js frontend
- Python 3.11+ for FastAPI backend
- Better Auth configured in Next.js project
- `BETTER_AUTH_SECRET` environment variable set in both frontend and backend

## Environment Setup

1. **Set up environment variables**:
   ```bash
   # Frontend (.env.local)
   NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000
   BETTER_AUTH_SECRET=your-secret-key-here

   # Backend (.env)
   BETTER_AUTH_SECRET=your-secret-key-here
   ```

2. **Install required packages**:
   ```bash
   # Frontend
   npm install @better-auth/react @better-auth/next-js better-auth

   # Backend
   pip install pyjwt python-jose[cryptography] fastapi uvicorn
   ```

## Frontend Implementation

1. **Create auth configuration** (`frontend/src/lib/auth.ts`):
   ```typescript
   import { betterAuth } from "better-auth";
   import { jwtPlugin } from "@better-auth/plugins/jwt";

   export const auth = betterAuth({
     // auth configuration
     plugins: [
       jwtPlugin({
         secret: process.env.BETTER_AUTH_SECRET!,
       })
     ]
   });
   ```

2. **Initialize auth middleware** in Next.js app router

## Backend Implementation

1. **Create JWT verification dependency** (`backend/src/api/deps.py`):
   ```python
   from fastapi import Depends, HTTPException, status
   import jwt
   from typing import Dict, Any

   SECRET_KEY = os.getenv("BETTER_AUTH_SECRET")
   ALGORITHM = "HS256"

   def verify_token(token: str = Depends(get_token)):
       try:
           payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
           user_id: str = payload.get("sub")
           if user_id is None:
               raise HTTPException(
                   status_code=status.HTTP_401_UNAUTHORIZED,
                   detail="Could not validate credentials"
               )
           return payload
       except jwt.JWTError:
           raise HTTPException(
               status_code=status.HTTP_401_UNAUTHORIZED,
               detail="Could not validate credentials"
           )
   ```

2. **Create user ownership verification**:
   ```python
   def verify_user_owns_resource(user_id_from_token: str, user_id_from_path: str):
       if user_id_from_token != user_id_from_path:
           raise HTTPException(
               status_code=status.HTTP_403_FORBIDDEN,
               detail="User does not have access to this resource"
           )
   ```

## Testing the Implementation

1. **Register and authenticate a user**:
   ```bash
   curl -X POST http://localhost:3000/api/auth/signup \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com", "password":"password123"}'
   ```

2. **Access protected endpoint**:
   ```bash
   curl -X GET http://localhost:8000/api/{user_id}/tasks \
     -H "Authorization: Bearer {jwt_token}"
   ```

3. **Verify access control**:
   - Try accessing another user's data with your token (should return 403)
   - Try accessing without token (should return 401)
   - Try accessing with invalid/expired token (should return 401)

## Key Integration Points

- JWT tokens generated by Better Auth contain 'sub' claim with user_id
- FastAPI endpoints extract user_id from JWT and compare with path parameter
- Shared BETTER_AUTH_SECRET ensures consistent token verification
- Proper error handling returns 401 for auth failures and 403 for authorization failures